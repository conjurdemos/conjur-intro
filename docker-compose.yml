version: "3"
services:
  conjur-master.mycompany.local:
    image: haproxy:2.1-alpine
    networks:
      dap_net:
        ipv4_address: 12.16.23.10
    ports:
      - "443:443"
      - "7000:7000"
    expose:
      - "1999"
      - "5432"
    volumes:
      - master-certs:/etc/ssl/certs
      - ./files/haproxy/master:/usr/local/etc/haproxy

  conjur-master-1.mycompany.local:
    # master build (without performance enhancements - did not work)
    #image: registry.tld/conjur-appliance:5.16.13-3085-20221109011404-b3a9c019
    # samir's fix (did not work) 
    #image: conjur-appliance:0.0.dev-20221107232244-de6182b4
    # micah's fix, 11/7
    #image: registry.tld/conjur-appliance:5.16.13-4-20221107180402-83303754
    # latest blocking (also not replicating?)
    #image: registry.tld/conjur-appliance:5.16.13-19-20221103135742-fbc40608
    # with MB's improvements (not replicating?)
    #image: registry.tld/conjur-appliance:5.16.13-2-20221104204844-daf096ac
    # micah's original image?
    #image: registry.tld/conjur-appliance:5.16.13-15-20221102175041-e1b68557
    # micah's step-by-step (everything works)
    #image: conjur-appliance:5.16.13.dev.1
    # the final fix??? Permissions in docker
    image: registry.tld/conjur-appliance:5.16.13-25-20221109200126-0fc29ed9
    # micah's updated image that he said works (11/9/2022):
    #image: registry.tld/conjur-appliance:5.16.13-20-20221109170755-73eef581
    # some random commit 1e0f33ff after implementing selective replication secrets did not replicate
    #image: registry.tld/conjur-appliance:5.16.13-3033-20221028193238-1e0f33ff
    # (working, does not implement selective replication though - defualt full) from 14 days before FRI NOV 4: https://jenkins.conjur.net/blue/organizations/jenkins/conjurinc--appliance/detail/master/3003/pipeline/80
    #image: registry.tld/conjur-appliance:5.16.13-3003-20221021221714-f4123968
    privileged: true
    networks:
      dap_net:
        ipv4_address: 12.16.23.11
    ports:
      - "444:443"
    expose:
      - "443"
      - "444"
      - "1999"
      - "5432"
    environment:
      TRUSTED_PROXIES: 123.123.1.1,123.5.1.1
    security_opt:
        - "seccomp:unconfined"
    volumes:
      - seeds:/opt/cyberark/dap/seeds
      - master-certs:/opt/conjur/etc/ssl/
      - ./system/backup:/opt/conjur/backup:Z
      - ./system/configuration:/opt/cyberark/dap/configuration:Z
      - ./system/logs/master-1:/var/log/conjur:Z
      - ./files:/conjur_files
      - ./files/dhparam.pem:${DHPATH}/dhparam.pem

  conjur-master-2.mycompany.local:
    # master build (without performance enhancements - did not work)
    #image: registry.tld/conjur-appliance:5.16.13-3085-20221109011404-b3a9c019
    # samir's fix (did not work) 
    #image: conjur-appliance:0.0.dev-20221107232244-de6182b4
    # micah's fix, 11/7
    #image: registry.tld/conjur-appliance:5.16.13-4-20221107180402-83303754
    # latest blocking (also not replicating?)
    #image: registry.tld/conjur-appliance:5.16.13-19-20221103135742-fbc40608
    # with MB's improvements (not replicating?)
    #image: registry.tld/conjur-appliance:5.16.13-2-20221104204844-daf096ac
    # micah's original image?
    #image: registry.tld/conjur-appliance:5.16.13-15-20221102175041-e1b68557
    # micah's step-by-step (everything works)
    #image: conjur-appliance:5.16.13.dev.1
    # the final fix??? Permissions in docker
    image: registry.tld/conjur-appliance:5.16.13-25-20221109200126-0fc29ed9
    # micah's updated image that he said works (11/9/2022):
    #image: registry.tld/conjur-appliance:5.16.13-20-20221109170755-73eef581
    # some random commit 1e0f33ff after implementing selective replication secrets did not replicate
    #image: registry.tld/conjur-appliance:5.16.13-3033-20221028193238-1e0f33ff
    # (working, does not implement selective replication though - defualt full) from 14 days before FRI NOV 4: https://jenkins.conjur.net/blue/organizations/jenkins/conjurinc--appliance/detail/master/3003/pipeline/80
    #image: registry.tld/conjur-appliance:5.16.13-3003-20221021221714-f4123968
    networks:
      dap_net:
        ipv4_address: 12.16.23.12
    ports:
      - "445:443"
    expose:
      - "443"
      - "444"
      - "1999"
      - "5432"
    security_opt:
        - "seccomp:unconfined"
    volumes:
      - seeds:/opt/cyberark/dap/seeds
      - master-certs:/opt/conjur/etc/ssl/
      - ./system/backup:/opt/conjur/backup:Z
      - ./system/configuration:/opt/cyberark/dap/configuration:Z
      - ./system/logs/master-2:/var/log/conjur:Z
      - ./files:/conjur_files

  conjur-master-3.mycompany.local:
    # master build (without performance enhancements - did not work)
    #image: registry.tld/conjur-appliance:5.16.13-3085-20221109011404-b3a9c019
    # samir's fix (did not work) 
    #image: conjur-appliance:0.0.dev-20221107232244-de6182b4
    # micah's fix, 11/7
    #image: registry.tld/conjur-appliance:5.16.13-4-20221107180402-83303754
    # latest blocking (also not replicating?)
    #image: registry.tld/conjur-appliance:5.16.13-19-20221103135742-fbc40608
    # with MB's improvements (not replicating?)
    #image: registry.tld/conjur-appliance:5.16.13-2-20221104204844-daf096ac
    # micah's original image?
    #image: registry.tld/conjur-appliance:5.16.13-15-20221102175041-e1b68557
    # micah's step-by-step (everything works)
    #image: conjur-appliance:5.16.13.dev.1
    # the final fix??? Permissions in docker
    image: registry.tld/conjur-appliance:5.16.13-25-20221109200126-0fc29ed9
    # micah's updated image that he said works (11/9/2022):
    #image: registry.tld/conjur-appliance:5.16.13-20-20221109170755-73eef581
    # some random commit 1e0f33ff after implementing selective replication secrets did not replicate
    #image: registry.tld/conjur-appliance:5.16.13-3033-20221028193238-1e0f33ff
    # (working, does not implement selective replication though - defualt full) from 14 days before FRI NOV 4: https://jenkins.conjur.net/blue/organizations/jenkins/conjurinc--appliance/detail/master/3003/pipeline/80
    #image: registry.tld/conjur-appliance:5.16.13-3003-20221021221714-f4123968
    networks:
      dap_net:
        ipv4_address: 12.16.23.13
    ports:
      - "446:443"
    expose:
      - "443"
      - "444"
      - "1999"
      - "5432"
    security_opt:
        - "seccomp:unconfined"
    volumes:
      - seeds:/opt/cyberark/dap/seeds
      - master-certs:/opt/conjur/etc/ssl/
      - ./system/backup:/opt/conjur/backup:Z
      - ./system/configuration:/opt/cyberark/dap/configuration:Z
      - ./system/logs/master-3:/var/log/conjur:Z
      - ./files:/conjur_files

  conjur-master-4.mycompany.local:
    # master build (without performance enhancements - did not work)
    #image: registry.tld/conjur-appliance:5.16.13-3085-20221109011404-b3a9c019
    # samir's fix (did not work) 
    #image: conjur-appliance:0.0.dev-20221107232244-de6182b4
    # micah's fix, 11/7
    #image: registry.tld/conjur-appliance:5.16.13-4-20221107180402-83303754
    # latest blocking (also not replicating?)
    #image: registry.tld/conjur-appliance:5.16.13-19-20221103135742-fbc40608
    # with MB's improvements (not replicating?)
    #image: registry.tld/conjur-appliance:5.16.13-2-20221104204844-daf096ac
    # micah's original image?
    #image: registry.tld/conjur-appliance:5.16.13-15-20221102175041-e1b68557
    # micah's step-by-step (everything works)
    #image: conjur-appliance:5.16.13.dev.1
    # the final fix??? Permissions in docker
    image: registry.tld/conjur-appliance:5.16.13-25-20221109200126-0fc29ed9
    # micah's updated image that he said works (11/9/2022):
    #image: registry.tld/conjur-appliance:5.16.13-20-20221109170755-73eef581
    # some random commit 1e0f33ff after implementing selective replication secrets did not replicate
    #image: registry.tld/conjur-appliance:5.16.13-3033-20221028193238-1e0f33ff
    # (working, does not implement selective replication though - defualt full) from 14 days before FRI NOV 4: https://jenkins.conjur.net/blue/organizations/jenkins/conjurinc--appliance/detail/master/3003/pipeline/80
    #image: registry.tld/conjur-appliance:5.16.13-3003-20221021221714-f4123968
    networks:
      dap_net:
        ipv4_address: 12.16.23.14
    ports:
      - "447:443"
    expose:
      - "443"
      - "444"
      - "1999"
      - "5432"
    security_opt:
        - "seccomp:unconfined"
    volumes:
      - seeds:/opt/cyberark/dap/seeds
      - master-certs:/opt/conjur/etc/ssl/
      - ./system/backup:/opt/conjur/backup:Z
      - ./system/configuration:/opt/cyberark/dap/configuration:Z
      - ./system/logs/master-4:/var/log/conjur:Z
      - ./files:/conjur_files

  conjur-master-5.mycompany.local:
    # master build (without performance enhancements - did not work)
    #image: registry.tld/conjur-appliance:5.16.13-3085-20221109011404-b3a9c019
    # samir's fix (did not work) 
    #image: conjur-appliance:0.0.dev-20221107232244-de6182b4
    # micah's fix, 11/7
    #image: registry.tld/conjur-appliance:5.16.13-4-20221107180402-83303754
    # latest blocking (also not replicating?)
    #image: registry.tld/conjur-appliance:5.16.13-19-20221103135742-fbc40608
    # with MB's improvements (not replicating?)
    #image: registry.tld/conjur-appliance:5.16.13-2-20221104204844-daf096ac
    # micah's original image?
    #image: registry.tld/conjur-appliance:5.16.13-15-20221102175041-e1b68557
    # micah's step-by-step (everything works)
    #image: conjur-appliance:5.16.13.dev.1
    # the final fix??? Permissions in docker
    image: registry.tld/conjur-appliance:5.16.13-25-20221109200126-0fc29ed9
    # micah's updated image that he said works (11/9/2022):
    #image: registry.tld/conjur-appliance:5.16.13-20-20221109170755-73eef581
    # some random commit 1e0f33ff after implementing selective replication secrets did not replicate
    #image: registry.tld/conjur-appliance:5.16.13-3033-20221028193238-1e0f33ff
    # (working, does not implement selective replication though - defualt full) from 14 days before FRI NOV 4: https://jenkins.conjur.net/blue/organizations/jenkins/conjurinc--appliance/detail/master/3003/pipeline/80
    #image: registry.tld/conjur-appliance:5.16.13-3003-20221021221714-f4123968
    networks:
      dap_net:
        ipv4_address: 12.16.23.15
    ports:
      - "448:443"
    expose:
      - "443"
      - "444"
      - "1999"
      - "5432"
    security_opt:
        - "seccomp:unconfined"
    volumes:
      - seeds:/opt/cyberark/dap/seeds
      - master-certs:/opt/conjur/etc/ssl/
      - ./system/backup:/opt/conjur/backup:Z
      - ./system/configuration:/opt/cyberark/dap/configuration:Z
      - ./system/logs/master-5:/var/log/conjur:Z
      - ./files:/conjur_files

  conjur-follower.mycompany.local:
    image: haproxy:2.1-alpine
    networks:
      dap_net:
        ipv4_address: 12.16.23.16
    ports:
      - "80:80"
      - "449:443"
      - "7001:7000"
    volumes:
      - follower-certs:/etc/ssl/certs
      - ./files/haproxy/follower:/usr/local/etc/haproxy

  conjur-follower-1.mycompany.local:
    privileged: true
    # master build (without performance enhancements - did not work)
    #image: registry.tld/conjur-appliance:5.16.13-3085-20221109011404-b3a9c019
    # samir's fix (did not work) 
    #image: conjur-appliance:0.0.dev-20221107232244-de6182b4
    # micah's fix, 11/7
    #image: registry.tld/conjur-appliance:5.16.13-4-20221107180402-83303754
    # latest blocking (also not replicating?)
    #image: registry.tld/conjur-appliance:5.16.13-19-20221103135742-fbc40608
    # with MB's improvements (not replicating?)
    #image: registry.tld/conjur-appliance:5.16.13-2-20221104204844-daf096ac
    # micah's original image?
    #image: registry.tld/conjur-appliance:5.16.13-15-20221102175041-e1b68557
    # micah's step-by-step (everything works)
    #image: conjur-appliance:5.16.13.dev.1
    # the final fix??? Permissions in docker
    image: registry.tld/conjur-appliance:5.16.13-25-20221109200126-0fc29ed9
    # micah's updated image that he said works (11/9/2022):
    #image: registry.tld/conjur-appliance:5.16.13-20-20221109170755-73eef581
    # some random commit 1e0f33ff after implementing selective replication secrets did not replicate
    #image: registry.tld/conjur-appliance:5.16.13-3033-20221028193238-1e0f33ff
    # (working, does not implement selective replication though - defualt full) from 14 days before FRI NOV 4: https://jenkins.conjur.net/blue/organizations/jenkins/conjurinc--appliance/detail/master/3003/pipeline/80
    #image: registry.tld/conjur-appliance:5.16.13-3003-20221021221714-f4123968
    networks:
      dap_net:
        ipv4_address: 12.16.23.17
    ports:
      - "450:443"
    expose:
      - "443"
      - "444"
    security_opt:
        - "seccomp:unconfined"
    volumes:
      - seeds:/opt/cyberark/dap/seeds
      - follower-certs:/opt/conjur/etc/ssl/
      - ./system/backup:/opt/conjur/backup:Z
      - ./system/configuration:/opt/cyberark/dap/configuration:Z
      - ./system/logs/follower:/var/log/conjur:Z
      - ./files:/conjur_files

  client:
    image: cyberark/conjur-cli:5
    networks:
      dap_net:
        ipv4_address: 12.16.23.18
    working_dir:  /src/cli
    environment:
      CONJUR_APPLIANCE_URL: https://conjur-master.mycompany.local
      CONJUR_ACCOUNT: demo
      CONJUR_AUTHN_LOGIN: admin
    volumes:
      - .:/src/cli
      - ./cli_cache/master:/root

  follower-client:
    image: cyberark/conjur-cli:5
    networks:
      dap_net:
        ipv4_address: 12.16.23.19
    working_dir:  /src/cli
    environment:
      CONJUR_APPLIANCE_URL: http://conjur-follower.mycompany.local
      CONJUR_ACCOUNT: demo
      CONJUR_AUTHN_LOGIN: admin
    volumes:
      - .:/src/cli
      - ./cli_cache/follower:/root

  api-client:
    build:
      context: ./artifacts/api-client
    networks:
      dap_net:
        ipv4_address: 12.16.23.20
    working_dir: /src/
    volumes:
      - ./artifacts/api-client/api-script:/src/bin/api
      - ./policy:/src/policy

  certificate-generator:
    build:
      context: ./artifacts/certificate-generator
    volumes:
      - ./system/configuration/certificates:/src/certificates

volumes:
  seeds:
  follower-certs:
  master-certs:

networks:
  dap_net:
    external: true
