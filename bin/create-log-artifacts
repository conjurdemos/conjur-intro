#!/usr/bin/env bash

# Fail early.
set -ex

# USAGE
#
# This script should be called by `replication-test`. It will also always be
# called by Jenkins, even if a job is aborted.
#
# ./bin/create-artifact-logs
#

# Always work from repo root directory
cd "$(dirname ${0})/..";

source ./bin/functions
source ./bin/utils.sh

LOG_DIR=
ARCHIVE_DIR="tmp/artifacts"

FOLLOWER_COUNT="${FOLLOWER_COUNT:-1}"

main(){
  echo "Beginning script: $0"

  if [[ -z "$LOG_DIR" ]]; then
    echo "FATAL: Argument '--log-directory' must be provided!"
    exit 1
  fi

  if [[ -z "$FOLLOWER_COUNT" ]]; then
    echo "FATAL: FOLLOWER_COUNT must be specified as --follower-count"
    exit 1
  fi

  echo "Creating log directory: $LOG_DIR..."
  mkdir -p "$LOG_DIR"

  timestamp=$(date +%Y%m%d%H%M%S)
  archive_filename="$ARCHIVE_DIR/appliance-logs-$timestamp.tgz"

  if [ -f "$archive_filename" ]; then
    echo "Log artifacts already exist at $archive_filename, SKIPPING!"
    exit 0
  fi

  echo "Dumping appliance logs..."

  ./bin/dump-leader-logs --no-fail --log-directory "$LOG_DIR/logs/leader"
  ./bin/dump-appliance-follower-logs --no-fail --log-directory "$LOG_DIR/logs/follower" --follower-count "${FOLLOWER_COUNT}"
  ./bin/dump-appliance-health-and-info --no-fail --follower-count "${FOLLOWER_COUNT}"

  echo "Dumping kubernetes logs..."
  ./bin/dump-k8s-resource-logs "$LOG_DIR/k8s-resources" "$(_get_k8s_follower_namespace)" "$(_get_k8s_operator_namespace)" || true

  echo "Tarballing logs to $archive_filename"
  tar -czvf "$archive_filename" -C "$LOG_DIR" .
}

while true ; do
  case "$1" in
    --log-directory ) shift; LOG_DIR="$1" ; shift ;;
    --follower-count ) shift; FOLLOWER_COUNT="$1" ; shift ;;
     * ) if [ -z "$1" ]; then break; else echo "$1 is not a valid option"; exit 1; fi;;
  esac
done

main
