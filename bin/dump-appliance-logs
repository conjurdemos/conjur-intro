#!/usr/bin/env bash

# USAGE
#
# Dumps the logs of the running Leader and all Followers up to the given
# FOLLOWER_COUNT. If the container is not running, no log is printed, and
# indicating a failure to configure / deploy a container, and this script will
# fail.
#
# ./bin/dump-appliance-logs 1
# ./bin/dump-appliance-logs 5
# ./bin/dump-appliance-logs 10

set -e

# Always work from repo root directory
cd "$(dirname ${0})/..";

source ./bin/utils.sh

LOG_DIR="tmp/appliance/logs"
LEADER_LOG_DIR="$LOG_DIR/leader"
FOLLOWER_LOG_DIR="$LOG_DIR/follower"
FOLLOWER_COUNT="$1"

# Use this to hide WARN from docker compose...
# WARN[0000] The "VERSION" variable is not set. Defaulting to a blank string. 
export VERSION=

main(){
  is_failure_detected_globally="false"

  if [[ -z "$FOLLOWER_COUNT" ]]; then
    echo "FATAL: FOLLOWER_COUNT must be specified as \$1"
    exit 1
  fi

  mkdir -p "$LEADER_LOG_DIR"
  mkdir -p "$FOLLOWER_LOG_DIR"

  echo "Dumping Leader Logs at: $LEADER_LOG_DIR"
  docker compose logs "conjur-master-1.mycompany.local" > "$LEADER_LOG_DIR/conjur-master-1.log"

  echo "Dumping Follower Logs at: $FOLLOWER_LOG_DIR"
  for ((i=1; i<=FOLLOWER_COUNT; i++))
  do
    FOLLOWER_HOSTNAME="conjur-follower-${i}.mycompany.local"

    container_id=$(docker-compose ps -q $FOLLOWER_HOSTNAME)
    if [ -z "$container_id" ]; then
      echo "WARNING: No container ID found for service '$FOLLOWER_HOSTNAME' (it is not running), skipping!"
      is_failure_detected_globally="true"
      continue
    fi

    echo "Dumping logs for '$FOLLOWER_HOSTNAME'"
    docker compose logs "$FOLLOWER_HOSTNAME" > "$FOLLOWER_LOG_DIR/conjur-follower-${i}.log"
  done

  if [ "$is_failure_detected_globally" = "true" ]; then
    echo "FATAL: An error was detected in at leats one node, see above."
    exit 1
  fi
  echo "DONE."
}

main "$@"