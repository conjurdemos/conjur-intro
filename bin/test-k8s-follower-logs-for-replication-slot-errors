#!/bin/bash
set -o pipefail

# USAGE
#
# Parses K8S Follower `postgres.log` files created by the `dump-k8s-logs`
# script for error patterns related to replication slots issues. Error patterns
# that are matched are prefixed with the line number of where the match
# occurred, and are tabbed in for (hopefully) better readability.
#
# NOTE: Leader and Follower logs are tested for different patterns/cases.
#
# ./bin/test-k8s-follower-logs-for-replication-slot-errors --log-directory tmp
#

# Always work from repo root directory
cd "$(dirname ${0})/..";

source ./bin/functions
source ./bin/utils.sh

LOG_DIR=

main(){
  local is_failure_detected_globally

  is_failure_detected_globally="false"
  failed_logs=()

  if [[ -z "$LOG_DIR" ]]; then
    echo "FATAL: Argument '--log-directory' must be provided!"
    exit 1
  fi

  if [ ! -d "$LOG_DIR" ]; then
    echo "FATAL: Directory does not exist: $LOG_DIR"
    exit 1
  fi

  # NOTE: this will parse all log files in the `FOLLOWER_LOG_DIR` directory
  # and its subdirectories. If K8S logs are dumped more than once, all logs will
  # be processed by this script, potentially resulting in re-scanning logs that
  # have already been checked. See the process substitution at the end of this
  # loop for how the input is read into this loop.
  while IFS= read -r -d '' file; do
    is_failure_detected_this_iteration="false"

    echo "Testing log file: $file..."

    if grep -n -E 'ERROR:  could not start WAL streaming: ERROR:  replication slot "pg_[0-9]+_sync_[0-9]+_[0-9]+" does not exist' "$file" | sed 's/^/\t/'; then
      is_failure_detected_this_iteration="true"
    fi

    # DISABLE: this seems to not be 100% indicative of failed replication.
    # if grep -n -E 'background worker "logical replication worker" \(PID [0-9]+\) exited with exit code [0-9]+' "$file" | sed 's/^/\t/'; then
    #   is_failure_detected_this_iteration="true"
    # fi

    if grep -n -E 'ERROR:  could not create replication slot "pg_[0-9]+_sync_[0-9]+_[0-9]+": ERROR:  replication slot "pg_[0-9]+_sync_[0-9]+_[0-9]+" already exists' "$file" | sed 's/^/\t/'; then
      is_failure_detected_this_iteration="true"
    fi

    if [ "$is_failure_detected_this_iteration" = "true" ]; then
      echo "ERROR: An error was detected in log file '$file', see above."
      is_failure_detected_globally="true"
      failed_logs+=("$file")
    fi
  done < <(find "$LOG_DIR" -name 'postgres.log' -print0)

  if [ "$is_failure_detected_globally" = "true" ]; then
    echo "Failures were detected in the following files:"
    for log in "${failed_logs[@]}"
    do
      echo "- $log"
    done
    echo "FATAL: An error was detected in at least one K8S Follower log file, see above."
    exit 1
  fi
  echo "SUCCESS: No errors were detected in any K8S Follower log file."
  echo "DONE."
}

while true ; do
  case "$1" in
    --log-directory ) shift; LOG_DIR="$1" ; shift ;;
     * ) if [ -z "$1" ]; then break; else echo "$1 is not a valid option"; exit 1; fi;;
  esac
done

main

