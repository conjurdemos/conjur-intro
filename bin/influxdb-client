#!/bin/bash
set -e
#
# Will execute a READ query on an influxdb host using the v2 HTTP API
# Reference: https://docs.influxdata.com/influxdb/v2.0/api/#tag/Authentication
#

source "$(git rev-parse --show-toplevel)/bin/functions"

# Will query InfluxDB, returning csv by default.
# Reference: https://docs.influxdata.com/influxdb/v2.0/api/#tag/Authentication
query_influx() {
    check_env "INFLUX_URL"
    check_env "INFLUX_TOKEN"
    check_env "INFLUX_ORG"

    local ACCEPT_HEADER=${ACCEPT_HEADER:-'Accept: application/csv'}
    local query="$1"; shift
    local out_file="$1"; shift

    curl --request POST "$INFLUX_URL/api/v2/query?org=$INFLUX_ORG" \
        --header "Content-Type: application/vnd.flux" \
        --header "Content-Encoding: gzip" \
        --header "$ACCEPT_HEADER" \
        --header "Authorization: Token ${INFLUX_TOKEN}" \
        --data "${query}" \
        --output "${out_file}"
}